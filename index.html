<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Who Clicked First? â€“ Multi-Laptop Buzzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin-top: 10px;
      text-align: center;
    }
    .container {
      background: #fff;
      padding: 20px 25px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      max-width: 480px;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      margin-top: 10px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
      text-align: left;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 14px;
    }
    .status {
      margin: 12px 0;
      padding: 10px;
      border-radius: 6px;
      background: #e9f3ff;
      border: 1px solid #c6ddff;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-direction: column;
    }
    .status span.winner {
      font-weight: bold;
      font-size: 18px;
    }
    button {
      font-size: 18px;
      padding: 12px 20px;
      margin: 10px 5px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      min-width: 140px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* BUZZ button visual states */
    #buzzBtn {
      font-size: 24px;
      font-weight: bold;
    }
    .buzz-ready {
      background-color: #2e7d32; /* green */
      color: #fff;
    }
    .buzz-disabled {
      background-color: #9e9e9e; /* grey */
      color: #fff;
    }

    .row {
      margin-top: 12px;
    }
    small {
      color: #666;
      font-size: 12px;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      margin-top: 8px;
      justify-content: flex-start;
      font-size: 14px;
    }
    .checkbox-row input {
      margin-right: 6px;
    }

    .name-display {
      font-size: 14px;
      margin-bottom: 10px;
    }

    .ranking-list {
      text-align: left;
      margin-top: 8px;
      width: 100%;
      max-width: 360px;
    }
    .ranking-list ol {
      padding-left: 20px;
      margin: 4px 0 0;
    }
  </style>
</head>
<body>
  <h1>Who Clicked First?</h1>

  <!-- SCREEN 1: JOIN -->
  <div class="container" id="screenJoin">
    <h2>Join Game</h2>
    <label for="playerNameJoin">Laptop / Player Name</label>
    <input type="text" id="playerNameJoin" placeholder="e.g., Laptop 1, Donnie, Team A" />

    <div class="checkbox-row">
      <input type="checkbox" id="isFacilitator" />
      <label for="isFacilitator" style="margin: 0;">I am the facilitator</label>
    </div>

    <div class="row">
      <button id="joinContinueBtn">Continue</button>
    </div>
    <div class="row">
      <small>
        Participants: enter your name and click Continue.<br />
        Facilitator: tick "I am the facilitator" (password required) then Continue.
      </small>
    </div>
  </div>

  <!-- SCREEN 2: GAME (PARTICIPANT) -->
  <div class="container" id="screenGame" style="display:none;">
    <h2>Game Screen</h2>
    <div class="name-display">
      Playing as: <strong><span id="currentNameLabel"></span></strong>
      <br />
      <button id="updateNameBtn" style="margin-top:8px; font-size:14px; padding:6px 10px; min-width:auto;">
        Update name / change mode
      </button>
    </div>

    <div class="status" id="statusBoxGame">
      Connecting to serverâ€¦
    </div>

    <button id="buzzBtn" class="buzz-disabled" disabled>BUZZ!</button>

    <div class="row">
      <small>
        When the facilitator resets the round, your BUZZ button will turn <strong>green</strong> (standby).  
        First green BUZZ click wins.
      </small>
    </div>
  </div>

  <!-- SCREEN 3: FACILITATOR -->
  <div class="container" id="screenFaci" style="display:none;">
    <h2>Facilitator Screen</h2>

    <div class="status" id="statusBoxFaci">
      Connecting to serverâ€¦
    </div>

    <div class="row checkbox-row" style="justify-content:center;">
      <input type="checkbox" id="faciShowRanking" />
      <label for="faciShowRanking" style="margin:0;">
        Show ranking (1st, 2nd, 3rdâ€¦) on all screens
      </label>
    </div>

    <div class="row">
      <button id="faciResetBtn">Reset Round / Turn All Buzzers Green</button>
    </div>

    <div class="row">
      <button id="faciBackBtn" style="font-size:14px; padding:6px 10px; min-width:auto;">
        Back to Join screen
      </button>
    </div>

    <div class="row">
      <small>
        Use Reset between questions.<br/>
        Until you reset, buzzers stay <strong>disabled</strong> (grey).<br/>
        After reset, all participants see a <strong>green BUZZ</strong> at the same time.
      </small>
    </div>
  </div>

  <script>
    // ===== CONFIG: CHANGE THIS TO YOUR RENDER BACKEND URL =====
    const BACKEND_URL = "https://buzzer-backend-vx86.onrender.com/";

    // Screen elements
    const screenJoin = document.getElementById("screenJoin");
    const screenGame = document.getElementById("screenGame");
    const screenFaci = document.getElementById("screenFaci");

    const playerNameJoinInput = document.getElementById("playerNameJoin");
    const isFacilitatorCheckbox = document.getElementById("isFacilitator");
    const joinContinueBtn = document.getElementById("joinContinueBtn");

    const currentNameLabel = document.getElementById("currentNameLabel");
    const updateNameBtn = document.getElementById("updateNameBtn");

    const statusBoxGame = document.getElementById("statusBoxGame");
    const statusBoxFaci = document.getElementById("statusBoxFaci");

    const buzzBtn = document.getElementById("buzzBtn");

    const faciResetBtn = document.getElementById("faciResetBtn");
    const faciBackBtn = document.getElementById("faciBackBtn");
    const faciShowRankingCheckbox = document.getElementById("faciShowRanking");

    let currentState = null;
    let playerName = "";
    let isFacilitatorMode = false;

    function showScreen(which) {
      screenJoin.style.display = "none";
      screenGame.style.display = "none";
      screenFaci.style.display = "none";

      if (which === "join") {
        screenJoin.style.display = "block";
      } else if (which === "game") {
        screenGame.style.display = "block";
      } else if (which === "faci") {
        screenFaci.style.display = "block";
      }
    }

    function setStatusGame(html) {
      if (statusBoxGame) statusBoxGame.innerHTML = html;
    }

    function setStatusFaci(html) {
      if (statusBoxFaci) statusBoxFaci.innerHTML = html;
    }

    function setBuzzVisual(enabled) {
      buzzBtn.disabled = !enabled;
      if (enabled) {
        buzzBtn.classList.remove("buzz-disabled");
        buzzBtn.classList.add("buzz-ready");
      } else {
        buzzBtn.classList.remove("buzz-ready");
        buzzBtn.classList.add("buzz-disabled");
      }
    }

    function buildRankingHTML(buzzes) {
      if (!buzzes || !buzzes.length) return "";
      let html = '<div class="ranking-list"><small>Buzz order:</small><ol>';
      buzzes.forEach((b, idx) => {
        const name = b.playerName || "Unknown";
        html += `<li>${name}</li>`;
      });
      html += "</ol></div>";
      return html;
    }

    async function fetchState() {
      try {
        const res = await fetch(BACKEND_URL + "/api/state");
        if (!res.ok) throw new Error("HTTP " + res.status);
        currentState = await res.json();
        updateUIFromState();
      } catch (err) {
        console.error(err);
        setStatusGame("Error connecting to server. Backend may be waking up.");
        setStatusFaci("Error connecting to server. Backend may be waking up.");
        setBuzzVisual(false);
      }
    }

    function updateUIFromState() {
      if (!currentState) {
        setStatusGame("No state.");
        setStatusFaci("No state.");
        setBuzzVisual(false);
        return;
      }

      // Keep facilitator checkbox synced with server setting
      if (faciShowRankingCheckbox) {
        faciShowRankingCheckbox.checked = !!currentState.showRanking;
      }

      const rankingHTML = currentState.showRanking
        ? buildRankingHTML(currentState.buzzes)
        : "";

      if (currentState.winner) {
        const winnerName = currentState.winner;
        const when = currentState.winnerTime
          ? new Date(currentState.winnerTime).toLocaleTimeString()
          : "";

        let gameMsg =
          `Winner for Round ${currentState.roundId}: ` +
          `<span class="winner">${winnerName}</span><br/><small>${when}</small>`;
        let faciMsg = gameMsg;

        if (rankingHTML) {
          gameMsg += rankingHTML;
          faciMsg += rankingHTML;
        }

        setStatusGame(gameMsg);
        setStatusFaci(faciMsg);

        // Winner exists â†’ all buzzers disabled (grey)
        setBuzzVisual(false);
      } else {
        let gameMsg =
          `Round ${currentState.roundId}: Standby.<br/>` +
          `<small>Buzzers are green and ready. Wait for facilitator signal.</small>`;
        let faciMsg =
          `Round ${currentState.roundId}: No winner yet.<br/>` +
          `<small>Click "Reset Round" only when you are ready for the next question.</small>`;

        if (rankingHTML) {
          gameMsg += rankingHTML;
          faciMsg += rankingHTML;
        }

        setStatusGame(gameMsg);
        setStatusFaci(faciMsg);

        // No winner yet â†’ all buzzers enabled (green)
        setBuzzVisual(true);
      }
    }

    async function sendBuzz() {
      if (!playerName) {
        alert("Enter a Laptop / Player Name first.");
        showScreen("join");
        return;
      }

      try {
        const res = await fetch(BACKEND_URL + "/api/buzz", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ playerName })
        });
        const data = await res.json();
        if (!data.ok) {
          alert("Error: " + (data.error || "Unknown error"));
          return;
        }
        currentState = data;

        if (data.first) {
          setStatusGame(
            `ðŸŽ‰ You won Round ${data.roundId}!<br/><span class="winner">${data.winner}</span>`
          );
        } else {
          setStatusGame(
            `Too late. Winner is <span class="winner">${data.winner}</span> for Round ${data.roundId}.`
          );
        }
        // After you buzz, your button is disabled (grey)
        setBuzzVisual(false);
      } catch (err) {
        console.error(err);
        alert("Error talking to server.");
      }
    }

    async function resetRound() {
      if (!confirm("Reset the round for ALL laptops and arm all buzzers (green)?")) return;

      try {
        const res = await fetch(BACKEND_URL + "/api/reset", {
          method: "POST"
        });
        const data = await res.json();
        if (!data.ok) {
          alert("Error resetting: " + (data.error || "Unknown error"));
          return;
        }
        currentState = data;
        updateUIFromState();
      } catch (err) {
        console.error(err);
        alert("Error talking to server.");
      }
    }

    async function updateSettingsShowRanking(showRanking) {
      try {
        const res = await fetch(BACKEND_URL + "/api/settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ showRanking })
        });
        const data = await res.json();
        if (!data.ok) {
          alert("Error updating settings: " + (data.error || "Unknown error"));
          return;
        }
        // Update local state to reflect change immediately
        if (currentState) {
          currentState.showRanking = data.showRanking;
          updateUIFromState();
        }
      } catch (err) {
        console.error(err);
        alert("Error talking to server.");
      }
    }

    // ----- Event wiring -----

    // Join flow
    joinContinueBtn.addEventListener("click", () => {
      const name = playerNameJoinInput.value.trim();
      const isFaciRequested = isFacilitatorCheckbox.checked;

      // Facilitator password check
      if (isFaciRequested) {
        const pw = prompt("Enter facilitator password:");
        if (pw !== "iloveinsights") {
          alert("Incorrect password.");
          isFacilitatorCheckbox.checked = false;
          return; // stay on join screen
        }
      }

      if (!name && !isFaciRequested) {
        alert("Enter a Laptop / Player Name first.");
        return;
      }

      playerName = name;
      isFacilitatorMode = isFaciRequested;

      // Save in localStorage for convenience
      if (playerName) {
        localStorage.setItem("buzzerPlayerName", playerName);
      }
      localStorage.setItem("buzzerIsFacilitator", isFacilitatorMode ? "1" : "0");

      if (isFacilitatorMode) {
        showScreen("faci");
      } else {
        currentNameLabel.textContent = playerName;
        showScreen("game");
      }
    });

    // Update name / change mode
    updateNameBtn.addEventListener("click", () => {
      // Pre-fill with current name
      playerNameJoinInput.value = playerName || "";
      isFacilitatorCheckbox.checked = false; // back as participant by default
      showScreen("join");
    });

    // BUZZ button
    buzzBtn.addEventListener("click", sendBuzz);

    // Facilitator reset button
    faciResetBtn.addEventListener("click", resetRound);

    // Facilitator back button
    faciBackBtn.addEventListener("click", () => {
      // Go back to join, keeping name + mode flag as last used
      playerNameJoinInput.value = playerName || "";
      isFacilitatorCheckbox.checked = isFacilitatorMode;
      showScreen("join");
    });

    // Facilitator ranking toggle
    faciShowRankingCheckbox.addEventListener("change", () => {
      const desired = faciShowRankingCheckbox.checked;
      updateSettingsShowRanking(desired);
    });

    // ----- Initial load -----
    // Load saved name / mode if any
    const savedName = localStorage.getItem("buzzerPlayerName");
    const savedIsFaci = localStorage.getItem("buzzerIsFacilitator") === "1";
    if (savedName) {
      playerNameJoinInput.value = savedName;
    }
    if (savedIsFaci) {
      isFacilitatorCheckbox.checked = true;
    }

    // Start on join screen
    showScreen("join");

    // Start polling backend
    fetchState();
    setInterval(fetchState, 1000);
  </script>
</body>
</html>


