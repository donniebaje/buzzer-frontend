<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Insights Training Game buzzer v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin-top: 10px;
      text-align: center;
    }
    .container {
      background: #fff;
      padding: 20px 25px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      max-width: 480px;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      margin-top: 10px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
      text-align: left;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 14px;
    }
    .status {
      margin: 12px 0;
      padding: 10px;
      border-radius: 6px;
      background: #e9f3ff;
      border: 1px solid #c6ddff;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-direction: column;
    }
    .status span.winner {
      font-weight: bold;
      font-size: 18px;
    }
    button {
      font-size: 18px;
      padding: 12px 20px;
      margin: 10px 5px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      min-width: 140px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* BUZZ button visual states + size (x6) */
    #buzzBtn {
      font-size: 48px;
      font-weight: bold;
      width: 100%;
      height: 220px;
      padding: 40px 20px;
      box-sizing: border-box;
    }
    .buzz-armed {
      background-color: #2e7d32; /* green */
      color: #fff;
    }
    .buzz-locked {
      background-color: #c62828; /* red */
      color: #fff;
    }
    .buzz-disabled {
      background-color: #9e9e9e; /* grey */
      color: #fff;
    }

    .row {
      margin-top: 12px;
    }
    small {
      color: #666;
      font-size: 12px;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      margin-top: 8px;
      justify-content: flex-start;
      font-size: 14px;
    }
    .checkbox-row input {
      margin-right: 6px;
    }

    .name-display {
      font-size: 14px;
      margin-bottom: 10px;
    }

    .ranking-list {
      text-align: left;
      margin-top: 8px;
      width: 100%;
      max-width: 360px;
    }
    .ranking-list ol {
      padding-left: 20px;
      margin: 4px 0 0;
    }

    .ready-list {
      text-align: left;
      margin-top: 8px;
      width: 100%;
      max-width: 360px;
    }
    .ready-list ul {
      padding-left: 20px;
      margin: 4px 0 0;
    }

    .footer {
      margin-top: 20px;
      font-size: 10px;
      color: #777;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Insights Training Game buzzer</h1>

  <!-- SCREEN 1: JOIN -->
  <div class="container" id="screenJoin">
    <h2>Join Game</h2>
    <label for="playerNameJoin">Laptop / Player Name</label>
    <input type="text" id="playerNameJoin" placeholder="e.g., Laptop 1, Donnie, Team A" />

    <div class="checkbox-row">
      <input type="checkbox" id="isFacilitator" />
      <label for="isFacilitator" style="margin: 0;">I am the facilitator</label>
    </div>

    <div class="row">
      <button id="joinContinueBtn">Continue</button>
    </div>
    <div class="row">
      <small>
        Participants: enter your name and click Continue.<br />
        Facilitator: tick "I am the facilitator" (password required) then Continue.
      </small>
    </div>
  </div>

  <!-- SCREEN 2: GAME (PARTICIPANT) -->
  <div class="container" id="screenGame" style="display:none;">
    <h2>Participant Screen</h2>
    <div class="name-display">
      Playing as: <strong><span id="currentNameLabel"></span></strong>
      <br />
      <button id="updateNameBtn" style="margin-top:8px; font-size:14px; padding:6px 10px; min-width:auto;">
        Update name / change mode
      </button>
    </div>

    <div class="status" id="statusBoxGame">
      Connecting to serverâ€¦
    </div>

    <button id="buzzBtn" class="buzz-locked" disabled>BUZZ!</button>

    <div class="row">
      <small>
        Your BUZZ button is <span style="color:#c62828;">red</span> when locked,<br/>
        <span style="color:#2e7d32;">green</span> when ready. Wait for facilitator.
      </small>
    </div>
  </div>

  <!-- SCREEN 3: FACILITATOR -->
  <div class="container" id="screenFaci" style="display:none;">
    <h2>Facilitator Screen</h2>

    <div class="status" id="statusBoxFaci">
      Connecting to serverâ€¦
    </div>

    <div class="row checkbox-row" style="justify-content:center;">
      <input type="checkbox" id="faciShowRanking" />
      <label for="faciShowRanking" style="margin:0;">
        Show ranking (1st, 2nd, 3rdâ€¦) on all screens
      </label>
    </div>

    <div class="row">
      <button id="faciResetBtn">Reset / Arm Buzzers (all laptops)</button>
    </div>

    <div class="row">
      <button id="faciBackBtn" style="font-size:14px; padding:6px 10px; min-width:auto;">
        Back to Join screen
      </button>
    </div>

    <div class="row">
      <small>
        Until you reset, buzzers stay <strong>locked and red</strong>.<br/>
        After reset, all participants see a <strong>green BUZZ</strong> at the same time.
      </small>
    </div>
  </div>

  <div class="footer">
    Copyright (C) Insights Training (donniebaje@gmail.com)
  </div>

  <script>
    // ===== CONFIG: CHANGE THIS TO YOUR RENDER BACKEND URL =====
    const BACKEND_URL = "https://buzzer-backend-vx86.onrender.com";

    // ========== Web Audio SFX ==========
    let audioCtx = null;

    function getAudioCtx() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
      }
      return audioCtx;
    }

    function playTone(freq, duration, type = "sine", gainValue = 1.0, startOffset = 0) {
      const ctx = getAudioCtx();
      const now = ctx.currentTime + startOffset;

      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = type;
      osc.frequency.setValueAtTime(freq, now);
      gain.gain.setValueAtTime(gainValue, now);

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start(now);
      osc.stop(now + duration);
    }

    // Sharp game-show buzzer
    function playBuzzSfx() {
      playTone(220, 0.08, "square", 1.0, 0);
      playTone(140, 0.12, "square", 1.0, 0.08);
    }

    // Winner sound â€“ rising confirmation
    function playWinnerSfx() {
      playTone(440, 0.12, "sine", 0.9, 0);
      playTone(660, 0.12, "sine", 0.9, 0.12);
      playTone(880, 0.25, "sine", 1.0, 0.24);
    }

    // Reset â€“ round start chime
    function playResetSfx() {
      playTone(523.25, 0.12, "sine", 0.9, 0);
      playTone(659.25, 0.2, "sine", 0.9, 0.12);
    }

    // Ready â€“ subtle ping when buzzers turn green
    function playReadySfx() {
      playTone(880, 0.12, "sine", 0.8, 0);
    }

    // ===== DOM refs =====
    const screenJoin = document.getElementById("screenJoin");
    const screenGame = document.getElementById("screenGame");
    const screenFaci = document.getElementById("screenFaci");

    const playerNameJoinInput = document.getElementById("playerNameJoin");
    const isFacilitatorCheckbox = document.getElementById("isFacilitator");
    const joinContinueBtn = document.getElementById("joinContinueBtn");

    const currentNameLabel = document.getElementById("currentNameLabel");
    const updateNameBtn = document.getElementById("updateNameBtn");

    const statusBoxGame = document.getElementById("statusBoxGame");
    const statusBoxFaci = document.getElementById("statusBoxFaci");

    const buzzBtn = document.getElementById("buzzBtn");

    const faciResetBtn = document.getElementById("faciResetBtn");
    const faciBackBtn = document.getElementById("faciBackBtn");
    const faciShowRankingCheckbox = document.getElementById("faciShowRanking");

    let currentState = null;
    let playerName = "";
    let isFacilitatorMode = false;

    function showScreen(which) {
      screenJoin.style.display = "none";
      screenGame.style.display = "none";
      screenFaci.style.display = "none";

      if (which === "join") {
        screenJoin.style.display = "block";
      } else if (which === "game") {
        screenGame.style.display = "block";
      } else if (which === "faci") {
        screenFaci.style.display = "block";
      }
    }

    function setStatusGame(html) {
      if (statusBoxGame) statusBoxGame.innerHTML = html;
    }

    function setStatusFaci(html) {
      if (statusBoxFaci) statusBoxFaci.innerHTML = html;
    }

    function setBuzzVisual(mode) {
      buzzBtn.classList.remove("buzz-armed", "buzz-disabled", "buzz-locked");
      if (mode === "armed") {
        buzzBtn.disabled = false;
        buzzBtn.classList.add("buzz-armed");
      } else if (mode === "locked") {
        buzzBtn.disabled = true;
        buzzBtn.classList.add("buzz-locked");
      } else {
        buzzBtn.disabled = true;
        buzzBtn.classList.add("buzz-disabled");
      }
    }

    function buildRankingHTML(buzzes) {
      if (!buzzes || !buzzes.length) return "";
      let html = '<div class="ranking-list"><small>Buzz order (with time):</small><ol>';
      buzzes.forEach((b) => {
        const name = b.playerName || "Unknown";
        const d = new Date(b.time);
        const t = d.toLocaleTimeString(undefined, { hour12: false });
        const ms = String(d.getMilliseconds()).padStart(3, "0");
        html += `<li>${name} â€“ ${t}.${ms}</li>`;
      });
      html += "</ol></div>";
      return html;
    }

    function buildReadyHTML(names) {
      if (!names || !names.length) {
        return '<div class="ready-list"><small>Ready participants: (none yet)</small></div>';
      }
      let html = '<div class="ready-list"><small>Ready participants:</small><ul>';
      names.forEach((n) => {
        html += `<li>${n}</li>`;
      });
      html += "</ul></div>";
      return html;
    }

    async function fetchState() {
      try {
        const res = await fetch(BACKEND_URL + "/api/state");
        if (!res.ok) throw new Error("HTTP " + res.status);
        currentState = await res.json();
        updateUIFromState();
      } catch (err) {
        console.error(err);
        setStatusGame("Error connecting to server. Backend may be waking up.");
        setStatusFaci("Error connecting to server. Backend may be waking up.");
        setBuzzVisual("disabled");
      }
    }

    function updateUIFromState() {
      if (!currentState) {
        setStatusGame("No state.");
        setStatusFaci("No state.");
        setBuzzVisual("disabled");
        return;
      }

      // Keep facilitator ranking toggle synced
      if (faciShowRankingCheckbox) {
        faciShowRankingCheckbox.checked = !!currentState.showRanking;
      }

      const rankingHTML = currentState.showRanking
        ? buildRankingHTML(currentState.buzzes)
        : "";
      const readyHTML = buildReadyHTML(currentState.readyPlayers);

      // FACI + GAME messages differ based on armed/winner
      if (!currentState.armed) {
        // Not armed yet â€“ buzzers red, not clickable
        setStatusGame(
          `Waiting for facilitator to arm the buzzers.<br/><small>Your BUZZ button will turn green when ready.</small>`
        );

        let faciMsg = `Buzzers are currently <strong>locked</strong> (red) on all laptops.<br/><small>Click "Reset / Arm Buzzers" when you are ready to start.</small>`;
        faciMsg += readyHTML;
        if (rankingHTML) faciMsg += rankingHTML;
        setStatusFaci(faciMsg);

        setBuzzVisual("locked");
        return;
      }

      // Armed = true
      if (currentState.winner) {
        const winnerName = currentState.winner;
        const when = currentState.winnerTime
          ? new Date(currentState.winnerTime).toLocaleTimeString(undefined, { hour12: false })
          : "";

        let gameMsg =
          `Winner: <span class="winner">${winnerName}</span><br/><small>${when}</small>`;
        let faciMsg = gameMsg;

        if (rankingHTML) {
          gameMsg += rankingHTML;
          faciMsg += rankingHTML;
        }
        faciMsg += readyHTML;

        setStatusGame(gameMsg);
        setStatusFaci(faciMsg);

        setBuzzVisual("disabled");
      } else {
        // Armed and no winner yet
        let gameMsg =
          `Standby.<br/><small>Your BUZZ button is green when ready. Wait for facilitator signal.</small>`;
        let faciMsg =
          `Buzzers are <strong>armed</strong> and ready.<br/><small>Ask participants to BUZZ when ready.</small>`;

        if (rankingHTML) {
          gameMsg += rankingHTML;
          faciMsg += rankingHTML;
        }
        faciMsg += readyHTML;

        setStatusGame(gameMsg);
        setStatusFaci(faciMsg);

        // If we were previously not armed, play ready sound
        if (!buzzBtn.classList.contains("buzz-armed")) {
          playReadySfx();
        }
        setBuzzVisual("armed");
      }
    }

    async function sendBuzz() {
      if (!playerName) {
        alert("Enter a Laptop / Player Name first.");
        showScreen("join");
        return;
      }

      // Play buzzer immediately on click
      playBuzzSfx();

      try {
        const res = await fetch(BACKEND_URL + "/api/buzz", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ playerName })
        });
        const data = await res.json();
        if (!data.ok) {
          if (data.error) alert("Error: " + data.error);
          return;
        }
        currentState = data;

        if (data.first) {
          playWinnerSfx();
          setStatusGame(
            `ðŸŽ‰ You won!<br/><span class="winner">${data.winner}</span>`
          );
        } else {
          setStatusGame(
            `Too late. Winner is <span class="winner">${data.winner}</span>.`
          );
        }
        setBuzzVisual("disabled");
      } catch (err) {
        console.error(err);
        alert("Error talking to server.");
      }
    }

    async function resetRound() {
      if (!confirm("Reset and arm all buzzers (they will turn green on all laptops)?")) return;

      try {
        const res = await fetch(BACKEND_URL + "/api/reset", {
          method: "POST"
        });
        const data = await res.json();
        if (!data.ok) {
          alert("Error resetting: " + (data.error || "Unknown error"));
          return;
        }
        currentState = data;
        playResetSfx();
        updateUIFromState();
      } catch (err) {
        console.error(err);
        alert("Error talking to server.");
      }
    }

    async function updateSettingsShowRanking(showRanking) {
      try {
        const res = await fetch(BACKEND_URL + "/api/settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ showRanking })
        });
        const data = await res.json();
        if (!data.ok) {
          alert("Error updating settings: " + (data.error || "Unknown error"));
          return;
        }
        if (currentState) {
          currentState.showRanking = data.showRanking;
          updateUIFromState();
        }
      } catch (err) {
        console.error(err);
        alert("Error talking to server.");
      }
    }

    async function setReadyOnServer(ready) {
      if (!playerName) return;
      try {
        await fetch(BACKEND_URL + "/api/ready", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ playerName, ready })
        });
      } catch (err) {
        console.error("Error updating ready state:", err);
      }
    }

    // ----- Event wiring -----

    joinContinueBtn.addEventListener("click", () => {
      const name = playerNameJoinInput.value.trim();
      const isFaciRequested = isFacilitatorCheckbox.checked;

      // Facilitator password check
      if (isFaciRequested) {
        const pw = prompt("Enter facilitator password:");
        if (pw !== "iloveinsights") {
          alert("Incorrect password.");
          isFacilitatorCheckbox.checked = false;
          return;
        }
      }

      if (!name && !isFaciRequested) {
        alert("Enter a Laptop / Player Name first.");
        return;
      }

      playerName = name;
      isFacilitatorMode = isFaciRequested;

      if (playerName) {
        localStorage.setItem("buzzerPlayerName", playerName);
      }
      localStorage.setItem("buzzerIsFacilitator", isFacilitatorMode ? "1" : "0");

      if (isFacilitatorMode) {
        showScreen("faci");
        // Facilitator is not "ready" as participant
        setReadyOnServer(false);
      } else {
        currentNameLabel.textContent = playerName;
        showScreen("game");
        setReadyOnServer(true);
      }
    });

    updateNameBtn.addEventListener("click", () => {
      playerNameJoinInput.value = playerName || "";
      isFacilitatorCheckbox.checked = false; // back as participant by default
      showScreen("join");
      setReadyOnServer(false);
    });

    buzzBtn.addEventListener("click", sendBuzz);

    faciResetBtn.addEventListener("click", resetRound);

    faciBackBtn.addEventListener("click", () => {
      playerNameJoinInput.value = playerName || "";
      isFacilitatorCheckbox.checked = isFacilitatorMode;
      showScreen("join");
    });

    faciShowRankingCheckbox.addEventListener("change", () => {
      const desired = faciShowRankingCheckbox.checked;
      updateSettingsShowRanking(desired);
    });

    // ----- Initial load -----
    const savedName = localStorage.getItem("buzzerPlayerName");
    const savedIsFaci = localStorage.getItem("buzzerIsFacilitator") === "1";
    if (savedName) {
      playerNameJoinInput.value = savedName;
      playerName = savedName;
    }
    if (savedIsFaci) {
      isFacilitatorCheckbox.checked = true;
    }

    showScreen("join");

    fetchState();
    setInterval(fetchState, 1000);
  </script>
</body>
</html>

